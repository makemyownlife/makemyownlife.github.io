<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta name="keywords" content="RocketMQ,消息队列,设计,精要,架构"><meta name="description" content="一本RocketMQ电子书，希望对你有帮助！"><meta property="og:url" content="https://javayong.cn/mq/rocketmq4/01RocketMQ4_artch.html"><meta property="og:site_name" content="勇哥Java实战"><meta property="og:title" content="RocketMQ 整体架构"><meta property="og:description" content="1 专业术语 Producer 消息生产者，负责产生消息，一般由业务系统负责产生消息。 Consumer 消息消费者，负责消费消息，一般是后台系统负责异步消费。 PushConsumer Consumer 的一种，应用通常向 Consumer 对象注册一个 Listener 接口，一旦收到消息，Consumer 对象立刻回调 Listener 接口方法。 PullConsumer Consumer 的一种，应用通常主动调用 Consumer 的拉消息方法从 Broker 拉消息，主动权由应用控制。 ProducerGroup 一类 Producer 的集合名称，这类 Producer 通常发送一类消息，且发送逻辑一致。 ConsumerGroup 一类 Consumer 的集合名称，这类 Consumer 通常消费一类消息，且消费逻辑一致。 Broker 消息中转角色，负责存储消息，转发消息，一般也称为 Server。在 JMS 规范中称为 Provider。 广播消费 一条消息被多个 Consumer 消费，即使这些 Consumer 属于同一个 Consumer Group，消息也会被 Consumer Group 中的每个 Consumer 都消费一次，广播消费中的 Consumer Group 概念可以认为在消息划分方面无意义。 集群消费 一个 Consumer Group 中的 Consumer 实例平均分摊消费消息。例如某个 Topic 有 9 条消息，其中一个 Consumer Group 有 3 个实例(可能是 3 个进程，或者 3 台机器)，那举每个实例只消费其中的 3 条消息。 顺序消息 消费消息的顺序要同发送消息的顺序一致，在 RocketMQ 中，主要是指的是局部顺序，即一类消息为满足顺序性，必须 Producer 单线程顺序发送，且发送到同一个队列，这样 Consumer 就可以按照 Producer 发送的顺序去消费消息。 Message Queue 在 RocketMQ 中，所有消息队列都是持久化，长度无限的数据结构，所谓长度无限是指队列中的每个存储单元都是定长，访问其中的存储单元使用 Offset 来访问，offset 为 java long 类型，64 位，理论上在 100 年内不会溢出，另外队列中只保存最近几天的数据，之前的数据会按照过期时间来删除。也可以认为 Message Queue 是一个长度无限的数组，offset 就是下标。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-11-17T07:53:52.000Z"><meta property="article:author" content="勇哥"><meta property="article:tag" content="RocketMQ"><meta property="article:tag" content="消息队列"><meta property="article:modified_time" content="2023-11-17T07:53:52.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ 整体架构","image":[""],"dateModified":"2023-11-17T07:53:52.000Z","author":[{"@type":"Person","name":"勇哥","url":"https://javayong.cn/article/"}]}</script><meta name="robots" content="all"><meta name="author" content="Courage"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="apple-mobile-web-app-capable" content="yes"><script>var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?137150e962505ffc59b9c326764971af";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();</script><link rel="alternate" type="application/atom+xml" href="https://javayong.cn/atom.xml" title="勇哥Java实战 Atom Feed"><link rel="alternate" type="application/json" href="https://javayong.cn/feed.json" title="勇哥Java实战 JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://javayong.cn/rss.xml" title="勇哥Java实战 RSS Feed"><link rel="icon" href="/favicon.ico"><title>RocketMQ 整体架构 | 勇哥Java实战</title>
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-a66be8be.css" as="style"><link rel="stylesheet" href="/assets/style-a66be8be.css">
    <link rel="modulepreload" href="/assets/app-1c1562ff.js"><link rel="modulepreload" href="/assets/01RocketMQ4_artch.html-b48d43fb.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/01RocketMQ4_artch.html-53948723.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="vp-brand"><img class="vp-nav-logo" src="/logo.png" alt="勇哥Java实战"><!----><span class="vp-site-name hide-in-pad">勇哥Java实战</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a href="/cache/00localandclustercache.html" class="nav-link" aria-label="缓存实战"><span class="font-icon icon iconfont icon-buffer" style=""></span>缓存实战<!----></a></div><div class="nav-item hide-in-mobile"><a href="/mq/rocketmq4/00RocketMQ4_introduce.html" class="nav-link" aria-label="消息队列"><span class="font-icon icon iconfont icon-Kafka" style=""></span>消息队列<!----></a></div><div class="nav-item hide-in-mobile"><a href="/high-quality-technical-articles/" class="nav-link" aria-label="程序人生"><span class="font-icon icon iconfont icon-life-ring" style=""></span>程序人生<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://space.bilibili.com/472223327" rel="noopener noreferrer" target="_blank" aria-label="B站视频" class="nav-link"><span class="font-icon icon iconfont icon-bilibili" style=""></span>B站视频<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/makemyownlife" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-buffer" style=""></span><span class="vp-sidebar-title">缓存实战</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-Kafka" style=""></span><span class="vp-sidebar-title">消息队列</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-apacherocketmq" style=""></span><span class="vp-sidebar-title">RocketMQ4.X设计精要</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a href="/mq/rocketmq4/00RocketMQ4_introduce.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="序言"><!---->序言<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html" class="router-link-active router-link-exact-active nav-link active vp-sidebar-link vp-sidebar-page active" aria-label="RocketMQ 整体架构"><!---->RocketMQ 整体架构<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_1-专业术语" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="1 专业术语"><!---->1 专业术语<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-核心功能" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2 核心功能"><!---->2 核心功能<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-1-发布订阅" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.1 发布订阅"><!---->2.1 发布订阅<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-2-消息优先级" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.2 消息优先级"><!---->2.2 消息优先级<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-3-消息有序" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.3 消息有序"><!---->2.3 消息有序<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-4-消息过滤" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.4 消息过滤"><!---->2.4 消息过滤<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-5-消息持久化" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.5 消息持久化"><!---->2.5 消息持久化<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-6-消息可靠性" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.6 消息可靠性"><!---->2.6 消息可靠性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-7-低延迟消费" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.7 低延迟消费"><!---->2.7 低延迟消费<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-8-at-least-once" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.8 At least Once"><!---->2.8 At least Once<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-9-exactly-only-once" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.9 Exactly Only Once"><!---->2.9 Exactly Only Once<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-10-broker-的-buffer-满了怎么办" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.10 Broker 的 Buffer 满了怎么办?"><!---->2.10 Broker 的 Buffer 满了怎么办?<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-11-回溯消费" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.11 回溯消费"><!---->2.11 回溯消费<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-12-消息堆积" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.12 消息堆积"><!---->2.12 消息堆积<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-13-分布式事务" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.13 分布式事务"><!---->2.13 分布式事务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-14-定时消息" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.14 定时消息"><!---->2.14 定时消息<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-15-消息重试" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.15 消息重试"><!---->2.15 消息重试<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_3-架构概览" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="3 架构概览"><!---->3 架构概览<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/01RocketMQ4_network.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 网络通讯"><!---->RocketMQ 网络通讯<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/02RocketMQ4_nameserver.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 名字服务"><!---->RocketMQ 名字服务<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/03RocketMQ4_producer.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 生产者"><!---->RocketMQ 生产者<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/04RocketMQ4_store.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 存储模型"><!---->RocketMQ 存储模型<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/06RocketMQ4_consumer.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 消费者"><!---->RocketMQ 消费者<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/07RocketMQ4_broadcast_consumer.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 广播消费"><!---->RocketMQ 广播消费<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/08RocketMQ4_masterslave.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 主从同步"><!---->RocketMQ 主从同步<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/10RocketMQ4_transaction.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 事务原理"><!---->RocketMQ 事务原理<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/11RocketMQ4_messagetrack.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 消息轨迹"><!---->RocketMQ 消息轨迹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mq/rocketmq4/13RocketMQ4_subscribe_consistent.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="RocketMQ 订阅关系保持一致"><!---->RocketMQ 订阅关系保持一致<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-life-ring" style=""></span><span class="vp-sidebar-title">技术人生</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ 整体架构</h1><div class="page-info"><span class="page-author-info" aria-label="作者"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://javayong.cn/article/" target="_blank" rel="noopener noreferrer">勇哥</a></span><span property="author" content="勇哥"></span></span><span class="page-category-info" aria-label="分类"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">RocketMQ</span><!--]--><meta property="articleSection" content="RocketMQ"></span><span class="page-tag-info" aria-label="标签"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item clickable" role="navigation">RocketMQ</span><span class="page-tag-item clickable" role="navigation">消息队列</span><!--]--><meta property="keywords" content="RocketMQ,消息队列"></span><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-11-16T04:40:45.000Z"></span><!----><span class="page-word-info" aria-label="字数"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 4502 字</span><meta property="wordCount" content="4502"></span><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 15 分钟</span><meta property="timeRequired" content="PT15M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_1-专业术语" class="router-link-active router-link-exact-active toc-link level2">1 专业术语</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-核心功能" class="router-link-active router-link-exact-active toc-link level2">2 核心功能</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-1-发布订阅" class="router-link-active router-link-exact-active toc-link level3">2.1 发布订阅</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-2-消息优先级" class="router-link-active router-link-exact-active toc-link level3">2.2 消息优先级</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-3-消息有序" class="router-link-active router-link-exact-active toc-link level3">2.3 消息有序</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-4-消息过滤" class="router-link-active router-link-exact-active toc-link level3">2.4 消息过滤</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-5-消息持久化" class="router-link-active router-link-exact-active toc-link level3">2.5 消息持久化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-6-消息可靠性" class="router-link-active router-link-exact-active toc-link level3">2.6 消息可靠性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-7-低延迟消费" class="router-link-active router-link-exact-active toc-link level3">2.7 低延迟消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-8-at-least-once" class="router-link-active router-link-exact-active toc-link level3">2.8 At least Once</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-9-exactly-only-once" class="router-link-active router-link-exact-active toc-link level3">2.9 Exactly Only Once</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-10-broker-的-buffer-满了怎么办" class="router-link-active router-link-exact-active toc-link level3">2.10 Broker 的 Buffer 满了怎么办?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-11-回溯消费" class="router-link-active router-link-exact-active toc-link level3">2.11 回溯消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-12-消息堆积" class="router-link-active router-link-exact-active toc-link level3">2.12 消息堆积</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-13-分布式事务" class="router-link-active router-link-exact-active toc-link level3">2.13 分布式事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-14-定时消息" class="router-link-active router-link-exact-active toc-link level3">2.14 定时消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_2-15-消息重试" class="router-link-active router-link-exact-active toc-link level3">2.15 消息重试</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mq/rocketmq4/01RocketMQ4_artch.html#_3-架构概览" class="router-link-active router-link-exact-active toc-link level2">3 架构概览</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="_1-专业术语" tabindex="-1"><a class="header-anchor" href="#_1-专业术语" aria-hidden="true">#</a> 1 专业术语</h2><ul><li><p>Producer 消息生产者，负责产生消息，一般由业务系统负责产生消息。</p></li><li><p>Consumer 消息消费者，负责消费消息，一般是后台系统负责异步消费。</p></li><li><p>PushConsumer Consumer 的一种，应用通常向 Consumer 对象注册一个 Listener 接口，一旦收到消息，Consumer 对象立刻回调 Listener 接口方法。</p></li><li><p>PullConsumer</p><p>Consumer 的一种，应用通常主动调用 Consumer 的拉消息方法从 Broker 拉消息，主动权由应用控制。</p></li><li><p>ProducerGroup</p><p>一类 Producer 的集合名称，这类 Producer 通常发送一类消息，且发送逻辑一致。</p></li><li><p>ConsumerGroup</p><p>一类 Consumer 的集合名称，这类 Consumer 通常消费一类消息，且消费逻辑一致。</p></li><li><p>Broker</p><p>消息中转角色，负责存储消息，转发消息，一般也称为 Server。在 JMS 规范中称为 Provider。</p></li><li><p>广播消费</p><p>一条消息被多个 Consumer 消费，即使这些 Consumer 属于同一个 Consumer Group，消息也会被 Consumer Group 中的每个 Consumer 都消费一次，广播消费中的 Consumer Group 概念可以认为在消息划分方面无意义。</p></li><li><p>集群消费</p><p>一个 Consumer Group 中的 Consumer 实例平均分摊消费消息。例如某个 Topic 有 9 条消息，其中一个 Consumer Group 有 3 个实例(可能是 3 个进程，或者 3 台机器)，那举每个实例只消费其中的 3 条消息。</p></li><li><p>顺序消息 消费消息的顺序要同发送消息的顺序一致，在 RocketMQ 中，主要是指的是局部顺序，即一类消息为满足顺序性，必须 Producer 单线程顺序发送，且发送到同一个队列，这样 Consumer 就可以按照 Producer 发送的顺序去消费消息。</p></li><li><p>Message Queue 在 RocketMQ 中，所有消息队列都是持久化，长度无限的数据结构，所谓长度无限是指队列中的每个存储单元都是定长，访问其中的存储单元使用 Offset 来访问，offset 为 java long 类型，64 位，理论上在 100 年内不会溢出，另外队列中只保存最近几天的数据，之前的数据会按照过期时间来删除。也可以认为 Message Queue 是一个长度无限的数组，offset 就是下标。</p></li></ul><h2 id="_2-核心功能" tabindex="-1"><a class="header-anchor" href="#_2-核心功能" aria-hidden="true">#</a> 2 核心功能</h2><p>本节阐述消息中间件通常需要解决哪些问题，在解决这些问题当中会遇到什么困难，RocketMQ 是否可以解决，规范中如何定义这些问题。</p><h3 id="_2-1-发布订阅" tabindex="-1"><a class="header-anchor" href="#_2-1-发布订阅" aria-hidden="true">#</a> 2.1 发布订阅</h3><p>点对点（P2P）和发布订阅（Pub/Sub）是两种常见的消息队列模式，它们用于满足不同通信需求。</p><ol><li>点对点（P2P）模式： <ul><li>在点对点模式中，消息发送者（生产者）将消息发送到一个特定的队列，而消息接收者（消费者）从该队列中接收消息。</li><li>消息在队列中存储，一旦一个消息被消费者接收，它就从队列中移除，这确保了每个消息只被一个消费者处理。</li><li>这种模式适用于一对一的通信，其中一个生产者向一个特定的消费者发送消息，确保消息的可靠传递和处理。</li></ul></li><li>发布订阅（Pub/Sub）模式： <ul><li>在发布订阅模式中，消息发送者将消息发布到一个主题（topic），而消息订阅者则订阅感兴趣的主题。</li><li>每个主题可以有多个订阅者，因此消息会被广播到所有订阅了相同主题的消费者。</li><li>这种模式适用于一对多或多对多的通信，允许多个消费者同时接收和处理相同主题的消息。</li><li>发布订阅模式通常用于构建实时事件处理系统、日志处理、通知系统等，其中多个消费者需要订阅相同类型的消息并进行处理。</li></ul></li></ol><p>点对点模式适用于一对一的通信，确保消息的可靠传递给一个特定的消费者，而发布订阅模式适用于一对多或多对多的通信，允许多个消费者同时接收相同主题的消息，用于构建实时事件系统和广播通信。</p><h3 id="_2-2-消息优先级" tabindex="-1"><a class="header-anchor" href="#_2-2-消息优先级" aria-hidden="true">#</a> 2.2 消息优先级</h3><p>规范中描述的优先级是指在一个消息队列中，每条消息都有不同的优先级，一般用整数来描述，优先级高的消 息先投递，如果消息完全在一个内存队列中，那么在投递前可以按照优先级排序，令优先级高的先投递。</p><p>由于 RocketMQ 所有消息都是持久化的，所以如果按照优先级来排序，开销会非常大，因此 RocketMQ 没有特意支持消息优先级，但是可以通过变通的方式实现类似功能，即单独配置一个优先级高的队列，和一个普通优先级 的队列， 将不同优先级发送到不同队列即可。</p><p>对于优先级问题，可以归纳为 2 类：</p><ol><li>只要达到优先级目的即可，不是严格意义上的优先级，通常将优先级划分为高、中、低，或者再多几个级别。每个优先级可以用不同的 topic 表示，发消息时，指定不同的 Topic 来表示优先级，这种方式可以解决绝大部分的优先级问题，但是对业务的优先级精确性做了妥协。</li><li>严格的优先级，优先级用整数表示，例如 0 ~ 65535，这种优先级问题一般使用不同 topic 解决就非常不合适。如果要让 MQ 解决此问题，会对 MQ 的性能造成非常大的影响。这里要确保一点，业务上是否确实需</li></ol><p>要这种严格的优先级，如果将优先级压缩成几个，对业务的影响有多大 ?</p><h3 id="_2-3-消息有序" tabindex="-1"><a class="header-anchor" href="#_2-3-消息有序" aria-hidden="true">#</a> 2.3 消息有序</h3><p>消息有序指的是一类消息消费时，能按照发送的顺序来消费。例如:一个订单产生了 3 条消息，分别是订单创 建，订单付款，订单完成。消费时，要按照这个顺序消费才能有意义。但是同时订单之间是可以并行消费的。RocketMQ 可以严格的保证消息有序。</p><h3 id="_2-4-消息过滤" tabindex="-1"><a class="header-anchor" href="#_2-4-消息过滤" aria-hidden="true">#</a> 2.4 消息过滤</h3><ul><li><p>Broker 端消息过滤 在 Broker 中，按照 Consumer 的要求做过滤，优点是减少了对于 Consumer 无用消息的网络传输。 缺点是增加了 Broker 的负担，实现相对复杂。</p></li><li><p>Consumer 端消息过滤</p><p>这种过滤方式可由应用完全自定义实现，但是缺点是很多无用的消息要传输到 Consumer 端。</p></li></ul><h3 id="_2-5-消息持久化" tabindex="-1"><a class="header-anchor" href="#_2-5-消息持久化" aria-hidden="true">#</a> 2.5 消息持久化</h3><p>消息中间件通常采用的几种持久化方式:</p><ol><li>持久化到数据库，例如 Mysql 。</li><li>持久化到 KV 存储，例如 levelDB、伯克利 DB 等 KV 存储系统。</li><li>文件记录形式持久化，例如 Kafka，RocketMQ 。</li><li>对内存数据做一个持久化镜像，例如 beanstalkd，VisiNotify 。</li></ol><p>1，2, 3 三种持久化方式都具有将内存队列 Buffer 进行扩展的能力，4 只是一个内存的镜像，作用是当 Broker 挂掉重启后仍然能将之前内存的数据恢复出来。</p><p>JMS 与 CORBA Notification 规范没有明确说明如何持久化，但是持久化部分的性能直接决定了整个消息中间件 的性能。</p><p>RocketMQ 参考了 Kafka 的持久化方式，充分利用 Linux 文件系统内存 cache 来提高性能。</p><h3 id="_2-6-消息可靠性" tabindex="-1"><a class="header-anchor" href="#_2-6-消息可靠性" aria-hidden="true">#</a> 2.6 消息可靠性</h3><p>影响消息可靠性的几种情况:</p><ol><li><p>Broker 正常关闭</p></li><li><p>Broker 异常 Crash</p></li><li><p>OS Crash</p></li><li><p>机器掉电，但是能立即恢复供电情况。</p></li></ol><ol start="5"><li>机器无法开机(可能是cpu、主板、内存等关键设备损坏)</li><li>磁盘设备损坏。</li></ol><p>1、2、3、4 四种情况都属于硬件资源可立即恢复情况，RocketMQ 在这四种情况下能保证消息不丢，或者丢失少量数据(依赖刷盘方式是同步还是异步)。</p><p>5、6 属于单点故障，且无法恢复，一旦发生，在此单点上的消息全部丢失。</p><p>RocketMQ 在这两种情况下，通过异步复制，可保证 99%的消息不丢，但是仍然会有极少量的消息可能丢失。通过同步双写技术可以完全避免单点， 同步双写势必会影响性能，适合对消息可靠性要求极高的场合，例如与金额相关的应用。</p><h3 id="_2-7-低延迟消费" tabindex="-1"><a class="header-anchor" href="#_2-7-低延迟消费" aria-hidden="true">#</a> 2.7 低延迟消费</h3><p>在消息不堆积情况下，消息到达 Broker 后，能立刻到达 Consumer。 RocketMQ 使用长轮询 Pull 方式，可保证消息非常实时，消息实时性不低于 Push。</p><h3 id="_2-8-at-least-once" tabindex="-1"><a class="header-anchor" href="#_2-8-at-least-once" aria-hidden="true">#</a> 2.8 At least Once</h3><p>是指每个消息必须投递一次。RocketMQ Consumer 先 pull 消息到本地，消费完成后，才向服务器返回 ack，如果没有消费一定不会 ack 消息， 所以 RocketMQ 可以很好的支持此特性。</p><h3 id="_2-9-exactly-only-once" tabindex="-1"><a class="header-anchor" href="#_2-9-exactly-only-once" aria-hidden="true">#</a> 2.9 Exactly Only Once</h3><p>1、发送消息阶段，不允许发送重复的消息。 2、消费消息阶段，不允许消费重复的消息。 只有以上两个条件都满足情况下，才能认为消息是“Exactly Only Once”，而要实现以上两点，在分布式系统环境下，不可避免要产生巨大的开销。所以 RocketMQ 为了追求高性能，并不保证此特性，<strong>要求在业务上进行去重， 也就是说消费消息要做到幂等性</strong>。RocketMQ 虽然不能严格保证不重复，但是正常情况下很少会出现重复发送、消 费情况，只有网络异常，Consumer 启停等异常情况下会出现消息重复。</p><p><strong>此问题的本质原因是网络调用存在不确定性，即既不成功也不失败的第三种状态，所以才产生了消息重复性问题。</strong></p><h3 id="_2-10-broker-的-buffer-满了怎么办" tabindex="-1"><a class="header-anchor" href="#_2-10-broker-的-buffer-满了怎么办" aria-hidden="true">#</a> 2.10 Broker <strong>的</strong> <strong>Buffer</strong> 满了怎么办?</h3><p>Broker 的 Buffer 通常指的是 Broker 中一个队列的内存 Buffer 大小，这类 Buffer 通常大小有限，如果 Buffer 满 了以后怎么办?</p><p>下面是 CORBA Notification 规范中处理方式:</p><p>(1). RejectNewEvents 拒绝新来的消息，向 Producer 返回 RejectNewEvents 错误码。</p><p>(2). 按照特定策略丢弃已有消息</p><ol><li><p><strong>AnyOrder</strong> - Any event may be discarded on overflow. This is the default setting for this property.</p></li><li><p><strong>FifoOrder</strong> - The first event received will be the first discarded.</p></li><li><p><strong>LifoOrder</strong> - The last event received will be the first discarded.</p></li><li><p><strong>PriorityOrder</strong> - Events should be discarded in priority order, such that lower priority events will be discarded before higher priority events.</p></li><li><p><strong>DeadlineOrder</strong> - Events should be discarded in the order of shortest expiry deadline first. RocketMQ 没有内存 Buffer 概念，RocketMQ 的队列都是持久化磁盘，数据定期清除。</p></li></ol><p>对于此问题的解决思路，RocketMQ 同其他 MQ 有非常显著的区别，RocketMQ 的内存 Buffer 抽象成一个无限长度的队列，不管有多少数据进来都能装得下，这个无限是有前提的，Broker 会定期删除过期的数据，例如 Broker 只保存 3 天的消息，那么这个 Buffer 虽然长度无限，但是 3 天前的数据会被从队尾删除。</p><h3 id="_2-11-回溯消费" tabindex="-1"><a class="header-anchor" href="#_2-11-回溯消费" aria-hidden="true">#</a> 2.11 <strong>回溯消费</strong></h3><p>回溯消费是指 Consumer 已经消费成功的消息，由于业务上需求需要重新消费，要支持此功能，Broker 在向 Consumer 投递成功消息后，消息仍然需要保留。并且重新消费一般是按照时间维度，例如由于 Consumer 系统故障， 恢复后需要重新消费 1 小时前的数据，那么 Broker 要提供一种机制，可以按照时间维度来回退消费进度。</p><p>RocketMQ 支持按照时间回溯消费，时间维度精确到毫秒，可以向前回溯，也可以向后回溯。</p><h3 id="_2-12-消息堆积" tabindex="-1"><a class="header-anchor" href="#_2-12-消息堆积" aria-hidden="true">#</a> 2.12 消息堆积</h3><p>消息中间件的主要功能是异步解耦，还有个重要功能是挡住前端的数据洪峰，保证后端系统的稳定性，这就要 求消息中间件具有一定的消息堆积能力，消息堆积分以下两种情况:</p><ol><li>消息堆积在内存 Buffer，一旦超过内存 Buffer，可以根据一定的丢弃策略来丢弃消息，如 CORBA Notification 规范中描述。适合能容忍丢弃消息的业务，这种情况消息的堆积能力主要在于内存 Buffer 大小，而且消息堆积后，性能下降不会太大，因为内存中数据多少对于对外提供的访问能力影响有限。</li><li>消息堆积到持久化存储系统中，例如 DB ，KV 存储，文件记录形式。 当消息不能在内存 Cache 命中时，要不可避免的访问磁盘，会产生大量读 IO，读 IO 的吞吐量直接决定了 消息堆积后的访问能力。</li></ol><p>评估消息堆积能力主要有以下四点:</p><ol><li><p>消息能堆积多少条，多少字节 ? 即消息的堆积容量。</p></li><li><p>消息堆积后，发消息的吞吐量大小，是否会受堆积影响 ?</p></li><li><p>消息堆积后，正常消费的 Consumer 是否会受影响 ?</p></li><li><p>消息堆积后，访问堆积在磁盘的消息时，吞吐量有多大 ?</p></li></ol><h3 id="_2-13-分布式事务" tabindex="-1"><a class="header-anchor" href="#_2-13-分布式事务" aria-hidden="true">#</a> 2.13 分布式事务</h3><p>已知的几个分布式事务规范，如 XA，JTA 等。其中 XA 规范被各大数据库厂商广泛支持，如 Oracle，Mysql 等。 其中 XA 的 TM 实现佼佼者如 Oracle Tuxedo，在金融、电信等领域被广泛应用。</p><p>分布式事务涉及到两阶段提交问题，在数据存储方面的方面必然需要 KV 存储的支持，因为第二阶段的提交回滚需要修改消息状态，一定涉及到根据 Key 去查找 Message 的动作。RocketMQ 在第二阶段绕过了根据 Key 去查找 Message 的问题，采用第一阶段发送 Prepared 消息时，拿到了消息的 Offset，第二阶段通过 Offset 去访问消息， 并修改状态，Offset 就是数据的地址。</p><p>RocketMQ 这种实现事务方式，没有通过 KV 存储做，而是通过 Offset 方式，存在一个显著缺陷，即通过 Offset 更改数据，会令系统的脏页过多，需要特别关注。</p><h3 id="_2-14-定时消息" tabindex="-1"><a class="header-anchor" href="#_2-14-定时消息" aria-hidden="true">#</a> 2.14 定时消息</h3><p>定时消息是指消息发到 Broker 后，不能立刻被 Consumer 消费，要到特定的时间点或者等待特定的时间后才能 被消费。</p><p>如果要支持任意的时间精度，在 Broker 层面，必须要做消息排序，如果再涉及到持久化，那么消息排序要不 可避免的产生巨大性能开销。</p><p>RocketMQ 支持定时消息，但是不支持任意时间精度，支持特定的 level，例如定时 5s，10s，1m 等。</p><h3 id="_2-15-消息重试" tabindex="-1"><a class="header-anchor" href="#_2-15-消息重试" aria-hidden="true">#</a> 2.15 消息重试</h3><p>Consumer 消费消息失败后，要提供一种重试机制，令消息再消费一次。</p><p>消费失败通常可以认为有以下几种情况</p><ol><li>由于消息本身的原因，例如反序列化失败，消息数据本身无法处理(例如话费充值，当前消息的手机号被注销，无法充值)等。</li></ol><p>这种错误通常需要跳过这条消息，再消费其他消息，而这条失败的消息即使立刻重试消费，99%也不成功，</p><p>所以最好提供一种定时重试机制，即过 10s 秒后再重试。</p><ol start="2"><li>由于依赖的下游应用服务不可用，例如 db 连接不可用，外系统网络不可达等。</li></ol><p>遇到这种错误，即使跳过当前失败的消息，消费其他消息同样也会报错。这种情况建议应用 sleep 30s ，再消费下一条消息，这样可以减轻 Broker 重试消息的压力。</p><h2 id="_3-架构概览" tabindex="-1"><a class="header-anchor" href="#_3-架构概览" aria-hidden="true">#</a> 3 架构概览</h2><p>我们先对 RocketMQ 4.9.X 架构做一个概览。</p><figure><img src="https://www.javayong.cn/pics/temp//WmCfyfFaPD.webp!large.png" alt="" tabindex="0"><figcaption></figcaption></figure><p>整体架构中包含<strong>四种角色</strong> :</p><p><strong>1、NameServer</strong></p><p>名字服务是是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。它是一个非常简单的 Topic 路由注册中心，其角色类似 Dubbo 中的 zookeeper ，支持 Broker 的动态注册与发现。</p><p><strong>2、BrokerServer</strong></p><p>Broker 主要负责消息的存储、投递和查询以及服务高可用保证 。</p><p><strong>3、Producer</strong></p><p>消息发布的角色，Producer 通过 MQ 的负载均衡模块选择相应的 Broker 集群队列进行消息投递，投递的过程支持快速失败并且低延迟。</p><p><strong>4、Consumer</strong></p><p>消息消费的角色，支持以 push 推，pull 拉两种模式对消息进行消费。</p><p>RocketMQ 集群工作流程：</p><p>1、<strong>启动 NameServer</strong>，NameServer 起来后监听端口，等待 Broker、Producer 、Consumer 连上来，相当于一个路由控制中心。</p><p>2、<strong>Broker 启动</strong>，跟所有的 NameServer 保持长连接，定时发送心跳包。心跳包中包含当前 Broker信息( IP+端口等 )以及存储所有 Topic 信息。注册成功后，NameServer 集群中就有 Topic 跟 Broker 的映射关系。</p><p>3、收发消息前，先<strong>创建 Topic</strong>，创建 Topic 时需要指定该 Topic 要存储在哪些 Broker 上，也可以在发送消息时自动创建 Topic。</p><p>4、<strong>Producer 发送消息</strong>，启动时先跟 NameServer 集群中的其中一台建立长连接，并从 NameServer 中获取当前发送的 Topic 存在哪些 Broker 上，轮询从队列列表中选择一个队列，然后与队列所在的 Broker 建立长连接从而向 Broker 发消息。</p><p>5、Consumer 跟 Producer 类似，跟其中一台 NameServer 建立长连接，获取当前订阅 Topic 存在哪些 Broker 上，然后直接跟 Broker 建立连接通道，开始<strong>消费消息</strong>。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/makemyownlife/edit/main/docs/mq/rocketmq4/01RocketMQ4_artch.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zhangyong7120180@163.com">makemyownlife</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a href="/mq/rocketmq4/00RocketMQ4_introduce.html" class="nav-link prev" aria-label="序言"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->序言</div></a><a href="/mq/rocketmq4/01RocketMQ4_network.html" class="nav-link next" aria-label="RocketMQ 网络通讯"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">RocketMQ 网络通讯<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">鄂ICP备2023011240号-1</a></div><div class="vp-copyright">Copyright © 2023 勇哥</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-1c1562ff.js" defer></script>
  </body>
</html>
