<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta name="keywords" content="布隆过滤器,缓存，Redis"><meta name="description" content="Redis 事务包含两种模式 事务模式 和 Lua 脚本。"><meta property="og:url" content="https://javayong.cn/cache/07Redistransaction.html"><meta property="og:site_name" content="勇哥Java实战"><meta property="og:title" content="聊聊 Redis 事务"><meta property="og:description" content="准确的讲，Redis 事务包含两种模式 : 事务模式 和 Lua 脚本。 先说结论： Redis 的事务模式具备如下特点： 保证隔离性； 无法保证持久性； 具备了一定的原子性，但不支持回滚； 一致性的概念有分歧，假设在一致性的核心是约束的语意下，Redis 的事务可以保证一致性。 但 Lua 脚本更具备实用场景，它是另一种形式的事务，他具备一定的原子性，但脚本报错的情况下，事务并不会回滚。Lua 脚本可以保证隔离性，而且可以完美的支持后面的步骤依赖前面步骤的结果。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-11-17T07:53:52.000Z"><meta property="article:author" content="勇哥"><meta property="article:tag" content="cache"><meta property="article:tag" content="Redis"><meta property="article:modified_time" content="2023-11-17T07:53:52.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"聊聊 Redis 事务","image":[""],"dateModified":"2023-11-17T07:53:52.000Z","author":[{"@type":"Person","name":"勇哥","url":"https://javayong.cn/article/"}]}</script><meta name="robots" content="all"><meta name="author" content="Courage"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="apple-mobile-web-app-capable" content="yes"><script>var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?137150e962505ffc59b9c326764971af";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();</script><link rel="alternate" type="application/atom+xml" href="https://javayong.cn/atom.xml" title="勇哥Java实战 Atom Feed"><link rel="alternate" type="application/json" href="https://javayong.cn/feed.json" title="勇哥Java实战 JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://javayong.cn/rss.xml" title="勇哥Java实战 RSS Feed"><link rel="icon" href="/favicon.ico"><title>聊聊 Redis 事务 | 勇哥Java实战</title>
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-a66be8be.css" as="style"><link rel="stylesheet" href="/assets/style-a66be8be.css">
    <link rel="modulepreload" href="/assets/app-1c1562ff.js"><link rel="modulepreload" href="/assets/07Redistransaction.html-31fc1d8c.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/07Redistransaction.html-d8cfc4cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="vp-brand"><img class="vp-nav-logo" src="/logo.png" alt="勇哥Java实战"><!----><span class="vp-site-name hide-in-pad">勇哥Java实战</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a href="/cache/00localandclustercache.html" class="nav-link" aria-label="缓存实战"><span class="font-icon icon iconfont icon-buffer" style=""></span>缓存实战<!----></a></div><div class="nav-item hide-in-mobile"><a href="/mq/rocketmq4/00RocketMQ4_introduce.html" class="nav-link" aria-label="消息队列"><span class="font-icon icon iconfont icon-Kafka" style=""></span>消息队列<!----></a></div><div class="nav-item hide-in-mobile"><a href="/high-quality-technical-articles/" class="nav-link" aria-label="程序人生"><span class="font-icon icon iconfont icon-life-ring" style=""></span>程序人生<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://space.bilibili.com/472223327" rel="noopener noreferrer" target="_blank" aria-label="B站视频" class="nav-link"><span class="font-icon icon iconfont icon-bilibili" style=""></span>B站视频<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/makemyownlife" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-buffer" style=""></span><span class="vp-sidebar-title">缓存实战</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a href="/cache/00localandclustercache.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="聊聊本地缓存和分布式缓存"><!---->聊聊本地缓存和分布式缓存<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/cache/01fourJDKlocalcache.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="四种强大的JDK本地缓存"><!---->四种强大的JDK本地缓存<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/cache/02pagelistcache.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="聊聊分页列表缓存"><!---->聊聊分页列表缓存<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/cache/05boolfilter.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="详解布隆过滤器"><!---->详解布隆过滤器<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/cache/07Redistransaction.html" class="router-link-active router-link-exact-active nav-link active vp-sidebar-link vp-sidebar-page active" aria-label="聊聊 Redis 事务"><!---->聊聊 Redis 事务<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_1-事务原理" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="1 事务原理"><!---->1 事务原理<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_2-1-原子性" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.1 原子性"><!---->2.1 原子性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_2-2-隔离性" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.2 隔离性"><!---->2.2 隔离性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_2-3-持久性" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.3 持久性"><!---->2.3 持久性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_2-4-一致性" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.4 一致性"><!---->2.4 一致性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_2-5-事务特点" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="2.5 事务特点"><!---->2.5 事务特点<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_3-1-简介" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="3.1 简介"><!---->3.1 简介<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_3-2-eval-命令" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="3.2 EVAL 命令"><!---->3.2 EVAL 命令<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/cache/07Redistransaction.html#_3-3-evalsha-命令" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="3.3 EVALSHA 命令"><!---->3.3 EVALSHA 命令<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/cache/09SpringCache.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="品味Spring Cache设计之美"><!---->品味Spring Cache设计之美<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-Kafka" style=""></span><span class="vp-sidebar-title">消息队列</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-life-ring" style=""></span><span class="vp-sidebar-title">技术人生</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->聊聊 Redis 事务</h1><div class="page-info"><span class="page-author-info" aria-label="作者"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://javayong.cn/article/" target="_blank" rel="noopener noreferrer">勇哥</a></span><span property="author" content="勇哥"></span></span><span class="page-category-info" aria-label="分类"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">cache</span><!--]--><meta property="articleSection" content="cache"></span><span class="page-tag-info" aria-label="标签"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item clickable" role="navigation">cache</span><span class="page-tag-item clickable" role="navigation">Redis</span><!--]--><meta property="keywords" content="cache,Redis"></span><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-11-16T08:17:07.000Z"></span><!----><span class="page-word-info" aria-label="字数"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 4131 字</span><meta property="wordCount" content="4131"></span><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 14 分钟</span><meta property="timeRequired" content="PT14M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_1-事务原理" class="router-link-active router-link-exact-active toc-link level2">1 事务原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_2-1-原子性" class="router-link-active router-link-exact-active toc-link level2">2.1 原子性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_2-2-隔离性" class="router-link-active router-link-exact-active toc-link level2">2.2 隔离性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_2-3-持久性" class="router-link-active router-link-exact-active toc-link level2">2.3 持久性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_2-4-一致性" class="router-link-active router-link-exact-active toc-link level2">2.4 一致性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_2-5-事务特点" class="router-link-active router-link-exact-active toc-link level2">2.5 事务特点</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_3-1-简介" class="router-link-active router-link-exact-active toc-link level2">3.1 简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_3-2-eval-命令" class="router-link-active router-link-exact-active toc-link level2">3.2 EVAL 命令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cache/07Redistransaction.html#_3-3-evalsha-命令" class="router-link-active router-link-exact-active toc-link level2">3.3 EVALSHA 命令</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>准确的讲，Redis 事务包含两种模式 : <strong>事务模式</strong> 和 <strong>Lua 脚本</strong>。</p><p>先说结论：</p><p>Redis 的事务模式具备如下特点：</p><ul><li>保证隔离性；</li><li>无法保证持久性；</li><li>具备了一定的原子性，但不支持回滚；</li><li>一致性的概念有分歧，假设在一致性的核心是约束的语意下，Redis 的事务可以保证一致性。</li></ul><p>但 Lua 脚本更具备实用场景，它是另一种形式的事务，他具备一定的原子性，但脚本报错的情况下，事务并不会回滚。Lua 脚本可以保证隔离性，而且可以完美的支持<strong>后面的步骤依赖前面步骤的结果</strong>。</p><p><strong>Lua 脚本模式的身影几乎无处不在，比如分布式锁、延迟队列、抢红包等场景。</strong></p><h2 id="_1-事务原理" tabindex="-1"><a class="header-anchor" href="#_1-事务原理" aria-hidden="true">#</a> 1 事务原理</h2><p>Redis 的事务包含如下命令：</p><table><thead><tr><th style="text-align:left;">序号</th><th style="text-align:left;">命令及描述</th></tr></thead><tbody><tr><td style="text-align:left;">1</td><td style="text-align:left;">MULTI 标记一个事务块的开始。</td></tr><tr><td style="text-align:left;">2</td><td style="text-align:left;">EXEC 执行所有事务块内的命令。</td></tr><tr><td style="text-align:left;">3</td><td style="text-align:left;">DISCARD 取消事务，放弃执行事务块内的所有命令。</td></tr><tr><td style="text-align:left;">4</td><td style="text-align:left;">WATCH key [key ...] 监视一个(或多个) key ，如果在事务执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断。</td></tr><tr><td style="text-align:left;">5</td><td style="text-align:left;">UNWATCH 取消 WATCH 命令对所有 key 的监视。</td></tr></tbody></table><p>事务包含三个阶段：</p><ol><li>事务开启，使用 MULTI , 该命令标志着执行该命令的客户端从非事务状态切换至事务状态 ；</li><li>命令入队，MULTI 开启事务之后，客户端的命令并不会被立即执行，而是放入一个事务队列 ；</li><li>执行事务或者丢弃。如果收到 EXEC 的命令，事务队列里的命令将会被执行 ，如果是 DISCARD 则事务被丢弃。</li></ol><p>下面展示一个事务的例子。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; MULTI 
 OK
 redis&gt; SET msg &quot;hello world&quot;
 QUEUED
 redis&gt; GET msg
 QUEUED
 redis&gt; EXEC
 1) OK
 1) hello world
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里有一个疑问？在开启事务的时候，Redis key 可以被修改吗？</p><figure><img src="https://www.javayong.cn/pics/temp//zgcHEZMogT.webp!large" alt="img" tabindex="0"><figcaption>img</figcaption></figure><p><strong>在事务执行 EXEC 命令之前 ，Redis key 依然可以被修改</strong>。</p><p>在事务开启之前，我们可以 watch 命令监听 Redis key 。在事务执行之前，我们修改 key 值 ，事务执行失败，返回 <strong>nil</strong> 。</p><figure><img src="https://www.javayong.cn/pics/temp//s5X2lsfqGT.webp!large" alt="img" tabindex="0"><figcaption>img</figcaption></figure><p>通过上面的例子，watch 命令可以<strong>实现类似乐观锁的效果</strong> 。</p><h1 id="_2-事务的acid" tabindex="-1"><a class="header-anchor" href="#_2-事务的acid" aria-hidden="true">#</a> 2 事务的ACID</h1><h2 id="_2-1-原子性" tabindex="-1"><a class="header-anchor" href="#_2-1-原子性" aria-hidden="true">#</a> 2.1 原子性</h2><p>原子性是指：一个事务中的所有操作，或者全部完成，或者全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。</p><p>第一个例子：</p><p>在执行 EXEC 命令前，客户端发送的操作命令错误，比如：语法错误或者使用了不存在的命令。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; MULTI
 OK
 redis&gt; SET msg &quot;other msg&quot;
 QUEUED
 redis&gt; wrongcommand  ### 故意写错误的命令
 (error) ERR unknown command &#39;wrongcommand&#39; 
 redis&gt; EXEC
 (error) EXECABORT Transaction discarded because of previous errors.
 redis&gt; GET msg
 &quot;hello world&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个例子中，我们使用了不存在的命令，导致入队失败，整个事务都将无法执行 。</p><p>第二个例子：</p><p>事务操作入队时，命令和操作的数据类型不匹配 ，入队列正常，但执行 EXEC 命令异常 。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; MULTI  
 OK
 redis&gt; SET msg &quot;other msg&quot;
 QUEUED
 redis&gt; SET mystring &quot;I am a string&quot;
 QUEUED
 redis&gt; HMSET mystring name  &quot;test&quot;
 QUEUED
 redis&gt; SET msg &quot;after&quot;
 QUEUED
 redis&gt; EXEC
 1) OK
 2) OK
 3) (error) WRONGTYPE Operation against a key holding the wrong kind of value
 4) OK
 redis&gt; GET msg
 &quot;after&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个例子里，Redis 在执行 EXEC 命令时，如果出现了错误，Redis 不会终止其它命令的执行，事务也不会因为某个命令执行失败而回滚 。</p><p>综上，我对 Redis 事务原子性的理解如下：</p><ol><li>命令入队时报错， 会放弃事务执行，保证原子性；</li><li>命令入队时正常，执行 EXEC 命令后报错，不保证原子性；</li></ol><p>也就是：<strong>Redis 事务在特定条件下，才具备一定的原子性</strong> 。</p><h2 id="_2-2-隔离性" tabindex="-1"><a class="header-anchor" href="#_2-2-隔离性" aria-hidden="true">#</a> 2.2 隔离性</h2><p>数据库的隔离性是指：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。</p><p>事务隔离分为不同级别 ，分别是：</p><ul><li>未提交读（read uncommitted）</li><li>提交读（read committed）</li><li>可重复读（repeatable read）</li><li>串行化（serializable）</li></ul><p>首先，需要明确一点：Redis 并没有事务隔离级别的概念。这里我们讨论 Redis 的隔离性是指：<strong>并发场景下，事务之间是否可以做到互不干扰</strong>。</p><p>我们可以将事务执行可以分为 <strong>EXEC 命令执行前</strong>和 <strong>EXEC 命令执行后</strong>两个阶段，分开讨论。</p><ol><li>EXEC 命令执行前</li></ol><p>在事务原理这一小节，我们发现在事务执行之前 ，Redis key 依然可以被修改。此时，可以使用 <strong>WATCH 机制</strong>来实现乐观锁的效果。</p><ol><li>EXEC 命令执行后</li></ol><p>因为 Redis 是单线程执行操作命令， EXEC 命令执行后，Redis 会保证命令队列中的所有命令执行完 。 这样就可以保证事务的隔离性。</p><h2 id="_2-3-持久性" tabindex="-1"><a class="header-anchor" href="#_2-3-持久性" aria-hidden="true">#</a> 2.3 持久性</h2><p>数据库的持久性是指 ：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</p><p>Redis 的数据是否持久化取决于 Redis 的持久化配置模式 。</p><ol><li>没有配置 RDB 或者 AOF ，事务的持久性无法保证；</li><li>使用了 RDB模式，在一个事务执行后，下一次的 RDB 快照还未执行前，如果发生了实例宕机，事务的持久性同样无法保证；</li><li>使用了 AOF 模式；AOF 模式的三种配置选项 no 、everysec 都会存在数据丢失的情况 。always 可以保证事务的持久性，但因为性能太差，在生产环境一般不推荐使用。</li></ol><p>综上，<strong>redis 事务的持久性是无法保证的</strong> 。</p><h2 id="_2-4-一致性" tabindex="-1"><a class="header-anchor" href="#_2-4-一致性" aria-hidden="true">#</a> 2.4 一致性</h2><p>一致性的概念一直很让人困惑，在我搜寻的资料里，有两类不同的定义。</p><ol><li>维基百科</li></ol><p>我们先看下维基百科上一致性的定义：</p><blockquote><p>Consistency ensures that a transaction can only bring the database from one valid state to another, maintaining database invariants: any data written to the database must be valid according to all defined rules, including constraints, cascades, triggers, and any combination thereof. This prevents database corruption by an illegal transaction, but does not guarantee that a transaction is correct. Referential integrity guarantees the primary key – foreign key relationship.</p></blockquote><p>在这段文字里，一致性的核心是“<strong>约束</strong>”，“<strong>any data written to the database must be valid according to all defined rules</strong> ”。</p><p>如何理解约束？这里引用知乎问题 <strong>如何理解数据库的内部一致性和外部一致性</strong>，蚂蚁金服 OceanBase 研发专家韩富晟回答的一段话：</p><blockquote><p>“约束”由数据库的使用者告诉数据库，使用者要求数据一定符合这样或者那样的约束。当数据发生修改时，数据库会检查数据是否还符合约束条件，如果约束条件不再被满足，那么修改操作不会发生。</p><p>关系数据库最常见的两类约束是“唯一性约束”和“完整性约束”，表格中定义的主键和唯一键都保证了指定的数据项绝不会出现重复，表格之间定义的参照完整性也保证了同一个属性在不同表格中的一致性。</p><p>“ Consistency in ACID ”是如此的好用，以至于已经融化在大部分使用者的血液里了，使用者会在表格设计的时候自觉的加上需要的约束条件，数据库也会严格的执行这个约束条件。</p></blockquote><p>所以<strong>事务的一致性和预先定义的约束有关，保证了约束即保证了一致性</strong>。</p><p>我们细细品一品这句话： <strong>This prevents database corruption by an illegal transaction, but does not guarantee that a transaction is correct</strong>。</p><p>写到这里可能大家还是有点模糊，我们举经典<strong>转账</strong>的案例。</p><p>我们开启一个事务，张三和李四账号上的初始余额都是1000元，并且余额字段没有任何约束。张三给李四转账1200元。张三的余额更新为 -200 ， 李四的余额更新为2200。</p><p>从应用层面来看，这个事务明显不合法，因为现实场景中，用户余额不可能小于 0 ， 但是它完全遵循数据库的约束，所以从数据库层面来看，这个事务依然保证了一致性。</p><p>Redis 的事务一致性是指：Redis 事务在执行过程中符合数据库的约束，没有包含非法或者无效的错误数据。</p><p>我们分三种异常场景分别讨论：</p><ol><li>执行 EXEC 命令前，客户端发送的操作命令错误，事务终止，数据保持一致性；</li><li>执行 EXEC 命令后，命令和操作的数据类型不匹配，错误的命令会报错，但事务不会因为错误的命令而终止，而是会继续执行。正确的命令正常执行，错误的命令报错，从这个角度来看，数据也可以保持一致性；</li><li>执行事务的过程中，Redis 服务宕机。这里需要考虑服务配置的持久化模式。 <ul><li>无持久化的内存模式：服务重启之后，数据库没有保持数据，因此数据都是保持一致性的；</li><li>RDB / AOF 模式： 服务重启后，Redis 通过 RDB / AOF 文件恢复数据，数据库会还原到一致的状态。</li></ul></li></ol><p>综上所述，<strong>在一致性的核心是约束的语意下，Redis 的事务可以保证一致性</strong>。</p><ol><li>《设计数据密集型应用》</li></ol><p>这本书是分布式系统入门的神书。在事务这一章节有一段关于 ACID 的解释：</p><figure><img src="https://www.javayong.cn/pics/temp//zOQBAJrpdO.webp!large" alt="img" tabindex="0"><figcaption>img</figcaption></figure><blockquote><p>Atomicity, isolation, and durability are properties of the database,whereas consistency (in the ACID sense) is a property of the application. The application may rely on the database’s atomicity and isolation properties in order to achieve consistency, but it’s not up to the database alone. Thus, the letter C doesn’t really belong in ACID.</p></blockquote><p>原子性，隔离性和持久性是数据库的属性，而一致性（在 ACID 意义上）是应用程序的属性。应用可能依赖数据库的原子性和隔离属性来实现一致性，但这并不仅取决于数据库。因此，字母 C 不属于 ACID 。</p><p>很多时候，我们一直在纠结的一致性，其实就是指<strong>符合现实世界的一致性</strong>，现实世界的一致性才是事务追求的最终目标。</p><p>为了实现现实世界的一致性，需要满足如下几点：</p><ol><li>保证原子性，持久性和隔离性，如果这些特征都无法保证，那么事务的一致性也无法保证；</li><li>数据库本身的约束，比如字符串长度不能超过列的限制或者唯一性约束；</li><li>业务层面同样需要进行保障 。</li></ol><h2 id="_2-5-事务特点" tabindex="-1"><a class="header-anchor" href="#_2-5-事务特点" aria-hidden="true">#</a> 2.5 事务特点</h2><p>我们通常称 Redis 为内存数据库 , 不同于传统的关系数据库，为了提供了更高的性能，更快的写入速度，在设计和实现层面做了一些平衡，并不能完全支持事务的 ACID。</p><p>Redis 的事务具备如下特点：</p><ul><li>保证隔离性；</li><li>无法保证持久性；</li><li>具备了一定的原子性，但不支持回滚；</li><li>一致性的概念有分歧，假设在一致性的核心是约束的语意下，Redis 的事务可以保证一致性。</li></ul><p>从工程角度来看，假设事务操作中每个步骤需要依赖上一个步骤返回的结果，则需要通过 watch 来实现乐观锁 。</p><h1 id="_3-lua-脚本" tabindex="-1"><a class="header-anchor" href="#_3-lua-脚本" aria-hidden="true">#</a> 3 Lua 脚本</h1><h2 id="_3-1-简介" tabindex="-1"><a class="header-anchor" href="#_3-1-简介" aria-hidden="true">#</a> 3.1 简介</h2><figure><img src="https://www.javayong.cn/pics/temp//0g0mSCwReL.webp!large" alt="" tabindex="0"><figcaption></figcaption></figure><p>Lua 由标准 C 编写而成，代码简洁优美，几乎在所有操作系统和平台上都可以编译，运行。Lua 脚本可以很容易的被 C/C ++ 代码调用，也可以反过来调用 C/C++ 的函数，这使得 Lua 在应用程序中可以被广泛应用。</p><p>Lua 脚本在游戏领域大放异彩，大家耳熟能详的《大话西游II》，《魔兽世界》都大量使用 Lua 脚本。Java 后端工程师接触过的 api 网关，比如 <strong>Openresty</strong> ，<strong>Kong</strong> 都可以看到 Lua 脚本的身影。</p><p>从 Redis 2.6.0 版本开始， Redis内置的 Lua 解释器，可以实现在 Redis 中运行 Lua 脚本。</p><p>使用 Lua 脚本的好处 ：</p><ul><li>减少网络开销。将多个请求通过脚本的形式一次发送，减少网络时延。</li><li>原子操作。Redis会将整个脚本作为一个整体执行，中间不会被其他命令插入。</li><li>复用。客户端发送的脚本会永久存在 Redis 中，其他客户端可以复用这一脚本而不需要使用代码完成相同的逻辑。</li></ul><p>Redis Lua 脚本常用命令：</p><table><thead><tr><th>序号</th><th>命令及描述</th></tr></thead><tbody><tr><td>1</td><td>EVAL script numkeys key [key ...] arg [arg ...] 执行 Lua 脚本。</td></tr><tr><td>2</td><td>EVALSHA sha1 numkeys key [key ...] arg [arg ...] 执行 Lua 脚本。</td></tr><tr><td>3</td><td>SCRIPT EXISTS script [script ...] 查看指定的脚本是否已经被保存在缓存当中。</td></tr><tr><td>4</td><td>SCRIPT FLUSH 从脚本缓存中移除所有脚本。</td></tr><tr><td>5</td><td>SCRIPT KILL 杀死当前正在运行的 Lua 脚本。</td></tr><tr><td>6</td><td>SCRIPT LOAD script 将脚本 script 添加到脚本缓存中，但并不立即执行这个脚本。</td></tr></tbody></table><h2 id="_3-2-eval-命令" tabindex="-1"><a class="header-anchor" href="#_3-2-eval-命令" aria-hidden="true">#</a> 3.2 EVAL 命令</h2><p>命令格式：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> EVAL script numkeys key [key ...] arg [arg ...]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>说明：</p><ul><li><code>script</code>是第一个参数，为 Lua 5.1脚本；</li><li>第二个参数<code>numkeys</code>指定后续参数有几个 key；</li><li><code>key [key ...]</code>，是要操作的键，可以指定多个，在 Lua 脚本中通过<code>KEYS[1]</code>, <code>KEYS[2]</code>获取；</li><li><code>arg [arg ...]</code>，参数，在 Lua 脚本中通过<code>ARGV[1]</code>, <code>ARGV[2]</code>获取。</li></ul><p>简单实例：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; eval &quot;return ARGV[1]&quot; 0 100 
 &quot;100&quot;
 redis&gt; eval &quot;return {ARGV[1],ARGV[2]}&quot; 0 100 101
 1) &quot;100&quot;
 2) &quot;101&quot;
 redis&gt; eval &quot;return {KEYS[1],KEYS[2],ARGV[1]}&quot; 2 key1 key2 first second
 1) &quot;key1&quot;
 2) &quot;key2&quot;
 3) &quot;first&quot;
 4) &quot;second&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面演示下 Lua 如何调用 Redis 命令 ，通过<code>redis.call()</code>来执行了 Redis 命令 。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; set mystring &#39;hello world&#39;
 OK
 redis&gt; get mystring
 &quot;hello world&quot;
 redis&gt; EVAL &quot;return redis.call(&#39;GET&#39;,KEYS[1])&quot; 1 mystring
 &quot;hello world&quot;
 redis&gt; EVAL &quot;return redis.call(&#39;GET&#39;,&#39;mystring&#39;)&quot; 0
 &quot;hello world&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-evalsha-命令" tabindex="-1"><a class="header-anchor" href="#_3-3-evalsha-命令" aria-hidden="true">#</a> 3.3 EVALSHA 命令</h2><p>使用 EVAL 命令每次请求都需要传输 Lua 脚本 ，若 Lua 脚本过长，不仅会消耗网络带宽，而且也会对 Redis 的性能造成一定的影响。</p><p>思路是先将 Lua 脚本先缓存起来 , 返回给客户端 Lua 脚本的 sha1 摘要。 客户端存储脚本的 sha1 摘要 ，每次请求执行 EVALSHA 命令即可。</p><figure><img src="https://www.javayong.cn/pics/temp//zokNNe0Swx.webp!large" alt="img" tabindex="0"><figcaption>img</figcaption></figure><p>EVALSHA 命令基本语法如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; EVALSHA sha1 numkeys key [key ...] arg [arg ...] 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>实例如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> redis&gt; SCRIPT LOAD &quot;return &#39;hello world&#39;&quot;
 &quot;5332031c6b470dc5a0dd9b4bf2030dea6d65de91&quot;
 redis&gt; EVALSHA 5332031c6b470dc5a0dd9b4bf2030dea6d65de91 0
 &quot;hello world&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_4-事务-vs-lua-脚本" tabindex="-1"><a class="header-anchor" href="#_4-事务-vs-lua-脚本" aria-hidden="true">#</a> 4 事务 VS Lua 脚本</h1><blockquote><p>从定义上来说， <strong>Redis 中的脚本本身就是一种事务</strong>， 所以任何在事务里可以完成的事， 在脚本里面也能完成。 并且一般来说， 使用<strong>脚本要来得更简单，并且速度更快</strong>。</p><p>因为脚本功能是 Redis 2.6 才引入的， 而事务功能则更早之前就存在了， 所以 Redis 才会同时存在两种处理事务的方法。</p><p>不过<strong>我们并不打算在短时间内就移除事务功能</strong>， 因为事务提供了一种即使不使用脚本， 也可以避免竞争条件的方法， 而且事务本身的实现并不复杂。</p><p>-- https://redis.io/</p></blockquote><p>Lua 脚本是另一种形式的事务，他具备一定的原子性，但脚本报错的情况下，事务并不会回滚。Lua 脚本可以保证隔离性，而且可以完美的支持<strong>后面的步骤依赖前面步骤的结果</strong>。</p><p><strong>Lua 脚本模式的身影几乎无处不在，比如分布式锁、延迟队列、抢红包等场景。</strong></p><p>不过在编写 Lua 脚本时，要注意如下两点：</p><ol><li>为了避免 Redis 阻塞，Lua 脚本业务逻辑不能过于复杂和耗时；</li><li>仔细检查和测试 Lua 脚本 ，因为执行 Lua 脚本具备一定的原子性，不支持回滚。</li></ol></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/makemyownlife/edit/main/docs/cache/07Redistransaction.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zhangyong7120180@163.com">makemyownlife</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a href="/cache/05boolfilter.html" class="nav-link prev" aria-label="详解布隆过滤器"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->详解布隆过滤器</div></a><a href="/cache/09SpringCache.html" class="nav-link next" aria-label="品味Spring Cache设计之美"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">品味Spring Cache设计之美<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">鄂ICP备2023011240号-1</a></div><div class="vp-copyright">Copyright © 2023 勇哥</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-1c1562ff.js" defer></script>
  </body>
</html>
